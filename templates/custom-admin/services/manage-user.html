{% extends 'custom-admin/base.html' %}
{% load static %}
{% block content %}

<section class="manageActivitiesPage managepadding manageallpage">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <!-- THIS IS A TOP CONTENT START -->
        <div class="topContent">
          <h2 class="H2Heading">Manage Members</h2>
        </div>
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == "error" %}danger alert-dismissible fade show{% else %}{{message.tags}} alert-dismissible fade show{% endif %}" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                </div>
                
            {% endfor %}
        {% endif %}
        <!-- THIS IS A TOP CONTENT EXIT -->

        <!-- THIS IS A TABLE START -->
        <div class="scrollableTable">
          <div class="row">
            <div class="col-md-6">
                <div class="tableInputFilter ms-0">
                    <div class="activeInactiveUser">
                      <button class="customButton" id="activeUserBtn">Active Users <span id="activeCount">0</span></button>
                      <button class="customButton ms-2" id="inactiveUserBtn">Inactive Users <span id="inactiveCount">0</span></button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
              {% comment %} <input type="text" class="customInput searchTable" data-search-columns="0,1,2" placeholder="Search by name, email "> {% endcomment %}
              <form method="GET" class="mb-4">
                <div class="input-group">
                    <input type="search" class="customInput searchTable" name="search" 
                           placeholder="Search by email, name or phone" 
                           value="{{ search_query }}">
                    <div class="input-group-append">
                        <button class="btn btn-primary" style= "display:none"type="submit">Search</button>
                    </div>
                </div>
            </form>
            </div>
          </div>
          <div>
            <table cellpadding="1" cellspacing="1">
              <tr class="">
                <th>User ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th> Email</th>
                <th>Phone No.</th>
                <th>Plan</th>
                <th> Reg Date </th>
                {% comment %} <th>Last Login</th> {% endcomment %}
                <th> status </th>
                <th>Actions</th>
              </tr>
              <tbody>
                {% if users %}
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.first_name }}</td>
                    <td>{{ user.last_name }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.phone_number }}</td>
                    <td>
                        {% if user.plan %}
                            {{ user.plan.name }} ({{ user.plan.id }})
                        {% else %}
                            No Plan
                        {% endif %}
                    </td>
                    <td>{{ user.date_joined|date:"d/m/Y" }}</td>
                    {% comment %} <td>{{ user.last_login }}</td> {% endcomment %}
                    <td>
                        <div class="form-check form-switch">
                            <form method="post" action="{% url 'admin_panel:user_toggle' user.id %}">
                                {% csrf_token %}
                                <input class="form-check-input toggle-status" 
                                       type="checkbox" 
                                       {% if user.is_active %}checked{% endif %}
                                       onchange="this.form.submit()">
                            </form>
                        </div>
                    </td>
                    <td>
                        {% comment %} <button class="tableActionBtn edit-user" 
                                data-user-id="{{ user.id }}"
                                data-first-name="{{ user.first_name }}"
                                data-last-name="{{ user.last_name }}"
                                data-email="{{ user.email }}"
                                data-phone-number="{{ user.phone_number }}"
                                data-country-code="{{ country_code }}"
                                data-plan="{{ user.plan.id }}"
                                data-is-active="{{ user.is_active|lower }}">
                            <i class="fa fa-edit"></i>
                        </button> {% endcomment %}
                        <button class="tableActionBtn delete-user" 
                                data-user-id="{{ user.id }}">
                            <i class="fa fa-trash"></i>
                        </button>
                        <button class="tableActionBtn reset-password" 
                                data-user-id="{{ user.id }}">
                            <i class="fa fa-key"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="8" class="text-center">No users found.</td>
                </tr>
                {% endif %}
            </tbody>
            </table>
            <div class="tablePagination">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        {% if users.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
            
            
                        {% for num in users.paginator.page_range %}
                            <li class="page-item {% if users.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                            </li>
                        {% endfor %}
            
                        {% if users.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
          </div>
        </div>
        <!-- THIS IS A TABLE EXIT -->

      </div>
    </div>

  </div>
</section>  

<!-- Edit User Modal -->
<div class="modal fade customModal addDataModal" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="H2Heading">Edit User</h6>
                <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
                    <img src="{% static 'admin/images/close.png' %}" alt="" class="img-fluid">
                </button>
            </div>

            <div class="modal-body">
                <form method="post" action="{% url 'admin_panel:user_edit' %}">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" id="edit_user_id">
                    <div class="row row-gap-4">
                        <div class="col-md-6">
                            <label class="inputLabel">First Name</label>
                            <input type="text" name="first_name" id="edit_first_name" class="customInput" placeholder="Enter First Name">
                        </div>
                        <div class="col-md-6">
                            <label class="inputLabel">Last Name</label>
                            <input type="text" name="last_name" id="edit_last_name" class="customInput" placeholder="Enter Last Name">
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Email</label>
                            <input type="email" name="email" id="edit_email" class="customInput" placeholder="Enter Email">
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Plan</label>
                            <div class="customSingleSelect">
                                <div class="select-icon">
                                    <i class="fa fa-angle-down selectIcon"></i>
                                    <select name="plan" id="edit_plan" class="icons_select2" single="single">
                                        {% for plan in plans %}
                                            <option value="{{ plan.id }}">{{ plan.name }} ({{ plan.id }})</option>
                                        {% endfor %} 
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Country code</label>
                            <div class="customSingleSelect">
                                <div class="select-icon">
                                    <i class="fa fa-angle-down selectIcon"></i>
                                    <select name="country_code" id="edit_country_code" class="icons_select2" single="single">
                                        {% comment %} {% for code in country_codes %}
                                            <option value="{{ code.code }}">{{ code.name }} ({{ code.code }})</option>
                                        {% endfor %} {% endcomment %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Phone Number</label>
                            <input type="text" name="phone_number" id="edit_phone_number" class="customInput" placeholder="Enter Phone Number">
                        </div>

                        <div class="col-md-12">
                            <label class="inputLabel">Status</label>
                            <div class="customSingleSelect">
                                <div class="select-icon">
                                    <i class="fa fa-angle-down selectIcon"></i>
                                    <select name="is_active" id="edit_status" class="icons_select2" single="single">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <div class="modalFooter">
                            <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="customButton ms-2">Update</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade customModal addDataModal" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content text-center" style="height: 340px;">
            <div class="modal-body">
                <img src="{% static 'admin/images/svg-icon/Delete.svg' %}" alt="">
                <form method="post" id="deleteUserForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-12 my-4">
                            <h2 class="H2Heading">Confirm Delete</h2>
                            <h5 class="H5Heading mt-3">Are you sure you want to delete this user? This action cannot be undone.</h5>
                        </div>

                        <!-- Modal Footer -->
                        <div class="modalFooter">
                            <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="customRedButton ms-3">Delete</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade customModal addDataModal" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="H2Heading">Reset User Password</h6>
                <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
                    <img src="{% static 'admin/images/close.png' %}" alt="" class="img-fluid">
                </button>
            </div>
            <div class="modal-body">
                <form method="post" id="resetUserPasswordForm">
                    {% csrf_token %}
                    <div class="row row-gap-4">
                        <div class="col-md-12">
                            <label class="inputLabel">New Password</label>
                            <input type="password" name="password" id="reset_password" class="customInput" placeholder="Enter new password" required>
                        </div>
                        <div class="col-md-12">
                            <label class="inputLabel">Confirm New Password</label>
                            <input type="password" name="confirm_password" id="reset_confirm_password" class="customInput" placeholder="Confirm new password" required>
                        </div>
                        <!-- Modal Footer -->
                        <div class="modalFooter">
                            <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="customButton ms-2">Reset Password</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extrajs %}
<script>
$(document).ready(function() {
    // Edit user modal
    $('.edit-user').click(function() {
        var userId = $(this).data('user-id');
        var firstName = $(this).data('first-name');
        var lastName = $(this).data('last-name');
        var email = $(this).data('email');
        var phoneNumber = $(this).data('phone-number') || '';
        var countryCode = $(this).data('country-code') || '';
        var plan = $(this).data('plan');
        console.log(plan,'plan');
        var isActive = $(this).data('is-active');
        
        $('#edit_user_id').val(userId);
        $('#edit_first_name').val(firstName);
        $('#edit_last_name').val(lastName);
        $('#edit_email').val(email);
        $('#edit_phone_number').val(phoneNumber);
        $('#edit_country_code').val(countryCode).trigger('change.select2');
        $('#edit_plan').val(plan).trigger('change.select2');
        $('#edit_status').val(isActive ? "true" : "false").trigger('change.select2');// Changed to use isActive  
        $('#editUserModal').modal('show');
    });

    // Delete user modal
    $('.delete-user').click(function() {
        var userId = $(this).data('user-id');
        $('#deleteUserForm').attr('action', `/users/${userId}/delete/`);
        $('#deleteUserModal').modal('show');
    });

    // Reset password modal
    $('.reset-password').click(function() {
        var userId = $(this).data('user-id');
        $('#reset_user_id').val(userId);
        $('#resetUserPasswordForm').attr('action', `/users/${userId}/reset-password/`)
        $('#resetPasswordModal').modal('show');
    });

    fetch('https://restcountries.com/v3.1/all?fields=name,flags,idd,cca2').then(response => response.json()).then(data => {
    const select = document.getElementById('edit_country_code');
    data.forEach(country => {
      const code = country.idd?.root + (country.idd?.suffixes ? country.idd.suffixes[0] : '');
      if (code) {
        const option = document.createElement('option');
        option.value = country.cca2;  // use ISO country code for value (e.g., "IN")
        option.text = `${country.name.common} (${code})`;  // display country name and phone code
        select.appendChild(option);
      }
    });
  });

});
</script>
<script>
    $(document).ready(function() {
        function updateUserCounts() {
            let activeCount = 0;
            let inactiveCount = 0;
            
            $('.toggle-status').each(function() {
                if ($(this).is(':checked')) {
                    activeCount++;
                } else {
                    inactiveCount++;
                }
            });
    
            $('#activeCount').text(activeCount);
            $('#inactiveCount').text(inactiveCount);
        }
        updateUserCounts();
        $('.toggle-status').change(function() {
            updateUserCounts();
        });
    });
    </script>
{% endblock %}

