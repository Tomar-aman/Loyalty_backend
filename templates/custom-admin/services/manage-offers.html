{% extends 'custom-admin/base.html' %} {% load static %} {% block content %}

<section class="manageActivitiesPage managepadding manageallpage">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div
          class="topContent d-flex justify-content-between align-items-center mb-3"
        >
          <h2 class="H2Heading">Manage Business Offers</h2>
          <button
            class="topContentButton"
            data-bs-toggle="modal"
            data-bs-target="#addOfferModal"
          >
            <i class="fa fa-plus"></i> Add Offer
          </button>
        </div>
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{% if message.tags == "error" %}danger alert-dismissible fade show{% else %}{{message.tags}} alert-dismissible fade show{% endif %}" role="alert">
              {{ message }}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          {% endfor %}
        {% endif %}

        <!-- Search and Filters -->
        <div class="row mb-3">
          <div class="col-md-6">
            <form method="GET">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control searchTable"
                  name="search"
                  value="{{ search_query }}"
                  placeholder="Search offers, businesses..."
                />
                <button class="btn btn-outline-secondary" type="submit">
                  <i class="fa fa-search"></i>
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="scrollableTable">
          <table class="customTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Business</th>
                <th>Offer Title</th>
                <th>Description</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for offer in offers %}
              <tr>
                <td>{{ offer.id }}</td>
                <td>{{ offer.business.name }}</td>
                <td>{{ offer.title|truncatewords:5 }}</td>
                <td>{{ offer.description|truncatewords:8 }}</td>
                <td>{{ offer.start_date|date:"d/m/Y H:i" }}</td>
                <td>{{ offer.end_date|date:"d/m/Y H:i" }}</td>
                {% comment %}
                <td>
                  <span
                    class="badge {% if offer.is_active %}bg-success{% else %}bg-secondary{% endif %}"
                  >
                    {% if offer.is_active %}Active{% else %}Inactive{% endif %}
                  </span>
                </td>
                {% endcomment %}
                <td>
                  <div class="form-check form-switch">
                    <form
                      method="post"
                      action="{% url 'admin_panel:offer_toggle' offer.id %}"
                      style="display: inline"
                    >
                      {% csrf_token %}
                      <input
                        class="form-check-input toggle-status"
                        type="checkbox"
                        {% if offer.is_active %}
                        checked
                        {% endif %}
                        onchange="this.form.submit()"
                      />
                    </form>
                  </div>
                </td>
                <td>
                  <button
                    class="tableActionBtn edit-offer"
                    data-bs-toggle="modal"
                    data-bs-target="#editOfferModal"
                    data-offer-id="{{ offer.id }}"
                    data-business-id="{{ offer.business.id }}"
                    data-title="{{ offer.title|escapejs }}"
                    data-description="{{ offer.description|escapejs }}"
                    data-start-date="{{ offer.start_date|date:'Y-m-d\TH:i' }}"
                    data-coupon-code="{{ offer.coupon_code|escapejs }}"
                    data-end-date="{{ offer.end_date|date:'Y-m-d\TH:i' }}"
                    data-is-active="{{ offer.is_active }}"
                    data-edit-url="{% url 'admin_panel:offer_edit' offer.id %}"
                  >
                    <i class="fa fa-edit"></i>
                  </button>
                  <button
                    class="tableActionBtn delete-offer"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteOfferModal"
                    data-offer-id="{{ offer.id }}"
                    data-delete-url="{% url 'admin_panel:offer_delete' offer.id %}"
                  >
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center">No offers found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ========================= -->
<!-- ADD OFFER MODAL -->
<!-- ========================= -->
<div
  class="modal fade customModal addDataModal"
  id="addOfferModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="H2Heading">Add New Offer</h6>
        <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
          <img
            src="{% static 'admin/images/close.png' %}"
            alt=""
            class="img-fluid"
          />
        </button>
      </div>
      <div class="modal-body">
        <form
          method="post"
          action="{% url 'admin_panel:offer_add' %}"
          id="addOfferForm"
        >
          {% csrf_token %}
          <div class="row row-gap-4">
            <div class="col-md-12">
              <label class="inputLabel">Business</label>
              <select name="business" class="customInput" required>
                <option value="">Select Business</option>
                {% for business in businesses %}
                <option value="{{ business.id }}">{{ business.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-12">
              <label class="inputLabel">Offer Title</label>
              <input
                type="text"
                name="title"
                class="customInput"
                placeholder="Enter Offer Title"
                required
              />
            </div>
            <div class="col-md-12">
              <label class="inputLabel">Description</label>
              <textarea
                name="description"
                class="customInput"
                rows="3"
                placeholder="Enter Offer Description"
                required
              ></textarea>
            </div>
            <div class="col-md-12">
              <label class="inputLabel">Coupon Code</label>
              <input
                type="text"
                name="coupon_code"
                class="customInput"
                placeholder="Enter Coupon Code"
              />
            </div>
            <div class="col-md-6">
              <label class="inputLabel">Start Date & Time</label>
              <input
                type="datetime-local"
                name="start_date"
                class="customInput"
                required
              />
            </div>
            <div class="col-md-6">
              <label class="inputLabel">End Date & Time</label>
              <input
                type="datetime-local"
                name="end_date"
                class="customInput"
                required
              />
            </div>
            <div class="col-md-12">
              <label class="inputLabel">Status</label>
              <select name="is_active" class="customInput">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>
            <div class="modalFooter">
              <button
                type="button"
                class="customButton"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="customButton ms-2">Add Offer</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- EDIT OFFER MODAL -->
<!-- ========================= -->
<div
  class="modal fade customModal addDataModal"
  id="editOfferModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="H2Heading">Edit Offer</h6>
        <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
          <img
            src="{% static 'admin/images/close.png' %}"
            alt=""
            class="img-fluid"
          />
        </button>
      </div>
      <div class="modal-body">
        <form method="post" id="editOfferForm">
          {% csrf_token %}
          <input type="hidden" id="edit_offer_id" name="offer_id" />
          <div class="row row-gap-4">
            <div class="col-md-12">
              <label class="inputLabel">Business</label>
              <select
                id="edit_business"
                name="business"
                class="customInput"
                required
              >
                <option value="">Select Business</option>
                {% for business in businesses %}
                <option value="{{ business.id }}">{{ business.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-12">
              <label class="inputLabel">Offer Title</label>
              <input
                type="text"
                id="edit_title"
                name="title"
                class="customInput"
                required
              />
            </div>
            <div class="col-md-12">
              <label class="inputLabel">Description</label>
              <textarea
                id="edit_description"
                name="description"
                class="customInput"
                rows="3"
                required
              ></textarea>
            </div>
            <div class="col-md-12">
              <label class="inputLabel">Coupon Code</label>
              <input
                type="text"
                id="edit_coupon_code"
                name="coupon_code"
                class="customInput"
              />
            </div>
            <div class="col-md-6">
              <label class="inputLabel">Start Date & Time</label>
              <input
                type="datetime-local"
                id="edit_start_date"
                name="start_date"
                class="customInput"
                required
              />
            </div>
            <div class="col-md-6">
              <label class="inputLabel">End Date & Time</label>
              <input
                type="datetime-local"
                id="edit_end_date"
                name="end_date"
                class="customInput"
                required
              />
            </div>
            <div class="col-md-12">
              <label class="inputLabel">Status</label>
              <select id="edit_is_active" name="is_active" class="customInput">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>
            <div class="modalFooter">
              <button
                type="button"
                class="customButton"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="customButton ms-2">
                Update Offer
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- DELETE OFFER MODAL -->
<!-- ========================= -->
<div
  class="modal fade customModal addDataModal"
  id="deleteOfferModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content text-center" style="height: 340px">
      <div class="modal-body">
        <img src="{% static 'admin/images/svg-icon/Delete.svg' %}" alt="" />
        <h4>Are you sure?</h4>
        <p>Do you want to delete this offer?</p>
        <form method="post" id="deleteOfferForm">
          {% csrf_token %}
          <div class="modalFooter">
            <button type="button" class="customButton" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="submit" class="customButton ms-2 btn-danger">
              Delete
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extrajs %}
<script>
  $(document).ready(function () {
    let searchTimeout;

    // Debounce search
    $(".searchTable").on("keyup", function () {
      clearTimeout(searchTimeout);
      const searchValue = $(this).val();
      searchTimeout = setTimeout(function () {
        if (searchValue.length > 0 || searchValue.length === 0) {
          $("form").first().submit();
        }
      }, 500);
    });

    // ===== EDIT OFFER MODAL =====
    $(".edit-offer").click(function () {
      var offerId = $(this).data("offer-id");
      var businessId = $(this).data("business-id");
      var title = $(this).data("title");
      var description = $(this).data("description");
      var couponCode = $(this).data("coupon-code");
      var startDate = $(this).data("start-date");
      var endDate = $(this).data("end-date");
      var isActive = $(this).data("is-active") ? "true" : "false";
      var editUrl = $(this).data("edit-url");

      console.log("Editing offer ID:", offerId);
      console.log("Coupon Code:", couponCode);
      console.log("title:", title);

      $("#edit_offer_id").val(offerId);
      $("#edit_business").val(businessId);
      $("#edit_title").val(title);
      $("#edit_description").val(description);
      $("#edit_coupon_code").val(couponCode);
      $("#edit_start_date").val(startDate);
      $("#edit_end_date").val(endDate);
      $("#edit_is_active").val(isActive);
      $("#editOfferForm").attr("action", editUrl);
    });

    // ===== DELETE OFFER MODAL =====
    $(".delete-offer").click(function () {
      var deleteUrl = $(this).data("delete-url");
      $("#deleteOfferForm").attr("action", deleteUrl);
    });

    // Form validation for add offer
    $("#addOfferForm").submit(function (e) {
      const title = $('input[name="title"]').val().trim();
      const startDate = $('input[name="start_date"]').val();
      const endDate = $('input[name="end_date"]').val();

      if (title.length < 3) {
        e.preventDefault();
        alert("Offer title must be at least 3 characters");
        return false;
      }

      if (new Date(startDate) >= new Date(endDate)) {
        e.preventDefault();
        alert("End date must be after start date");
        return false;
      }
    });

    // Form validation for edit offer
    $("#editOfferForm").submit(function (e) {
      const title = $("#edit_title").val().trim();
      const startDate = $("#edit_start_date").val();
      const endDate = $("#edit_end_date").val();

      if (title.length < 3) {
        e.preventDefault();
        alert("Offer title must be at least 3 characters");
        return false;
      }

      if (new Date(startDate) >= new Date(endDate)) {
        e.preventDefault();
        alert("End date must be after start date");
        return false;
      }
    });
  });
</script>
{% endblock %}
