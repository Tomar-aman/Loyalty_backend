{% extends 'custom-admin/base.html' %}
{% load static %}
{% block content %}

<section class="manageActivitiesPage managepadding manageallpage">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <!-- TOP CONTENT START -->
        <div class="topContent">
          <h2 class="H2Heading">Manage Admins</h2>
           <!-- Add Admin Button -->
              <button class="topContentButton" data-bs-toggle="modal" data-bs-target="#addAdminModal">
                <i class="fa fa-plus"></i> Add Admin
              </button>
        </div>


        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == "error" %}danger alert-dismissible fade show{% else %}{{message.tags}} alert-dismissible fade show{% endif %}" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
        <!-- TOP CONTENT EXIT -->

        <!-- TABLE START -->
        <div class="scrollableTable">
          <div class="row">
            <div class="col-md-6">
                <div class="tableInputFilter ms-0">
                    <div class="activeInactiveUser">
                      <button class="customButton" id="activeAdminBtn">Active Admins <span id="activeCount">0</span></button>
                      <button class="customButton ms-2" id="inactiveAdminBtn">Inactive Admins <span id="inactiveCount">0</span></button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
              <form method="GET" class="mb-4">
                <div class="input-group">
                    <input type="search" class="customInput searchTable" name="search" 
                           placeholder="Search by email, name or phone" 
                           value="{{ search_query }}"
                           id="searchInput">
                    <div class="input-group-append">
                        <button class="btn btn-primary" style="display:none" type="submit">Search</button>
                    </div>
                </div>
            </form>
            </div>
          </div>

          <div>
            <table cellpadding="1" cellspacing="1">
              <thead>
                <tr>
                  <th>Admin ID</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Phone No.</th>
                  <th>Country Code</th>
                  <th>Joined Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if admins %}
                {% for admin in admins %}
                <tr>
                    <td>{{ admin.id }}</td>
                    <td>{{ admin.first_name }}</td>
                    <td>{{ admin.last_name }}</td>
                    <td>{{ admin.email }}</td>
                    <td>{{ admin.phone_number|default:"N/A" }}</td>
                    <td>{{ admin.country_code|default:"N/A" }}</td>
                    <td>{{ admin.date_joined|date:"d/m/Y" }}</td>
                    <td>
                        <div class="form-check form-switch">
                            <form method="post" action="{% url 'admin_panel:admin_toggle' admin.id %}" style="display:inline;">
                                {% csrf_token %}
                                <input class="form-check-input toggle-status" 
                                       type="checkbox" 
                                       {% if admin.is_active %}checked{% endif %}
                                       onchange="this.form.submit()">
                            </form>
                        </div>
                    </td>
                    <td>
                        <button class="tableActionBtn edit-admin" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editAdminModal"
                                data-admin-id="{{ admin.id }}"
                                data-first-name="{{ admin.first_name }}"
                                data-last-name="{{ admin.last_name }}"
                                data-email="{{ admin.email }}"
                                data-phone-number="{{ admin.phone_number }}"
                                data-country-code="{{ admin.country_code }}"
                                data-is-active="{{ admin.is_active|lower }}">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="tableActionBtn delete-admin" 
                                data-bs-toggle="modal"
                                data-bs-target="#deleteAdminModal"
                                data-admin-id="{{ admin.id }}">
                            <i class="fa fa-trash"></i>
                        </button>
                        <button class="tableActionBtn reset-password" 
                                data-bs-toggle="modal"
                                data-bs-target="#resetPasswordModal"
                                data-admin-id="{{ admin.id }}">
                            <i class="fa fa-key"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="9" class="text-center">No admins found.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
            
            <!-- PAGINATION -->
            {% if admins.has_other_pages %}
            <div class="tablePagination">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        {% if admins.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ admins.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in admins.paginator.page_range %}
                            <li class="page-item {% if admins.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                            </li>
                        {% endfor %}

                        {% if admins.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ admins.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
          </div>
        </div>
        <!-- TABLE EXIT -->

      </div>
    </div>
  </div>
</section>

<!-- ADD ADMIN MODAL -->
<div class="modal fade customModal addDataModal" id="addAdminModal" tabindex="-1" aria-labelledby="addAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="H2Heading">Add New Admin</h6>
                <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
                    <img src="{% static 'admin/images/close.png' %}" alt="" class="img-fluid">
                </button>
            </div>

            <div class="modal-body">
                <form method="post" action="{% url 'admin_panel:admin_add' %}">
                    {% csrf_token %}
                    <div class="row row-gap-4">
                        <div class="col-md-6">
                            <label class="inputLabel">First Name <span style="color: red;">*</span></label>
                            <input type="text" name="first_name" class="customInput" placeholder="Enter First Name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="inputLabel">Last Name <span style="color: red;">*</span></label>
                            <input type="text" name="last_name" class="customInput" placeholder="Enter Last Name" required>
                        </div>

                        <div class="col-md-12">
                            <label class="inputLabel">Email <span style="color: red;">*</span></label>
                            <input type="email" name="email" class="customInput" placeholder="Enter Email" required>
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Country Code</label>
                            <div class="customSingleSelect">
                                <div class="select-icon">
                                    <i class="fa fa-angle-down selectIcon"></i>
                                    <select name="country_code" id="add_country_code" class="icons_select2" single="single">
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Phone Number</label>
                            <input type="text" name="phone_number" class="customInput" placeholder="Enter Phone Number">
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Password <span style="color: red;">*</span></label>
                            <input type="password" name="password" class="customInput" placeholder="Enter Password" required>
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Confirm Password <span style="color: red;">*</span></label>
                            <input type="password" name="confirm_password" class="customInput" placeholder="Confirm Password" required>
                        </div>

                        <!-- Modal Footer -->
                        <div class="modalFooter">
                            <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="customButton ms-2">Create Admin</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- EDIT ADMIN MODAL -->
<div class="modal fade customModal addDataModal" id="editAdminModal" tabindex="-1" aria-labelledby="editAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="H2Heading">Edit Admin</h6>
                <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
                    <img src="{% static 'admin/images/close.png' %}" alt="" class="img-fluid">
                </button>
            </div>

            <div class="modal-body">
                <form method="post" id="editAdminForm">
                    {% csrf_token %}
                    <input type="hidden" name="admin_id" id="edit_admin_id">
                    <div class="row row-gap-4">
                        <div class="col-md-6">
                            <label class="inputLabel">First Name</label>
                            <input type="text" name="first_name" id="edit_first_name" class="customInput" placeholder="Enter First Name">
                        </div>
                        <div class="col-md-6">
                            <label class="inputLabel">Last Name</label>
                            <input type="text" name="last_name" id="edit_last_name" class="customInput" placeholder="Enter Last Name">
                        </div>

                        <div class="col-md-12">
                            <label class="inputLabel">Email</label>
                            <input type="email" name="email" id="edit_email" class="customInput" placeholder="Enter Email">
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Country Code</label>
                            <div class="customSingleSelect">
                                <div class="select-icon">
                                    <i class="fa fa-angle-down selectIcon"></i>
                                    <select name="country_code" id="edit_country_code" class="icons_select2" single="single">
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Phone Number</label>
                            <input type="text" name="phone_number" id="edit_phone_number" class="customInput" placeholder="Enter Phone Number">
                        </div>

                        <div class="col-md-12">
                            <label class="inputLabel">Status</label>
                            <div class="customSingleSelect">
                                <div class="select-icon">
                                    <i class="fa fa-angle-down selectIcon"></i>
                                    <select name="status" id="edit_status" class="icons_select2" single="single">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <div class="modalFooter">
                            <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="customButton ms-2">Update</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- DELETE ADMIN MODAL -->
<div class="modal fade customModal addDataModal" id="deleteAdminModal" tabindex="-1" aria-labelledby="deleteAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content text-center" style="height: 340px;">
            <div class="modal-body">
                <img src="{% static 'admin/images/svg-icon/Delete.svg' %}" alt="">
                <form method="post" id="deleteAdminForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-12 my-4">
                            <h2 class="H2Heading">Confirm Delete</h2>
                            <h5 class="H5Heading mt-3">Are you sure you want to delete this admin? This action cannot be undone.</h5>
                        </div>

                        <!-- Modal Footer -->
                        <div class="modalFooter">
                            <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="customRedButton ms-3">Delete</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- RESET PASSWORD MODAL -->
<div class="modal fade customModal addDataModal" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="H2Heading">Reset Admin Password</h6>
                <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
                    <img src="{% static 'admin/images/close.png' %}" alt="" class="img-fluid">
                </button>
            </div>
            <div class="modal-body">
                <form method="post" id="resetAdminPasswordForm">
                    {% csrf_token %}
                    <div class="row row-gap-4">
                        <div class="col-md-12">
                            <label class="inputLabel">New Password</label>
                            <input type="password" name="password" id="reset_password" class="customInput" placeholder="Enter new password" required>
                        </div>
                        <div class="col-md-12">
                            <label class="inputLabel">Confirm New Password</label>
                            <input type="password" name="confirm_password" id="reset_confirm_password" class="customInput" placeholder="Confirm new password" required>
                        </div>
                        <!-- Modal Footer -->
                        <div class="modalFooter">
                            <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="customButton ms-2">Reset Password</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extrajs %}
<script>
$(document).ready(function() {
    let searchTimeout;
    
    // Debounce search
    $('#searchInput').on('keyup', function() {
        clearTimeout(searchTimeout);
        const searchValue = $(this).val();
        
        searchTimeout = setTimeout(function() {
            if (searchValue.length > 0 || searchValue.length === 0) {
                $('form').submit();
            }
        }, 500); // 500ms delay
    });

    // Load country codes for both add and edit modals
    function loadCountryCodes(selectElementId) {
        fetch('https://restcountries.com/v3.1/all?fields=name,flags,idd,cca2')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById(selectElementId);
                select.innerHTML = '<option value="">Select Country Code</option>';
                
                data.forEach(country => {
                    const code = country.idd?.root + (country.idd?.suffixes ? country.idd.suffixes[0] : '');
                    if (code) {
                        const option = document.createElement('option');
                        option.value = country.cca2;
                        option.text = `${country.name.common} (${code})`;
                        select.appendChild(option);
                    }
                });
                
                if (typeof $ !== 'undefined' && $.fn.select2) {
                    $(select).select2();
                }
            })
            .catch(error => console.error('Error loading countries:', error));
    }

    // Load countries on page load
    loadCountryCodes('add_country_code');
    loadCountryCodes('edit_country_code');

    // Edit admin modal
    $('.edit-admin').click(function() {
        var adminId = $(this).data('admin-id');
        var firstName = $(this).data('first-name');
        var lastName = $(this).data('last-name');
        var email = $(this).data('email');
        var phoneNumber = $(this).data('phone-number') || '';
        var countryCode = $(this).data('country-code') || '';
        var isActive = $(this).data('is-active');
        
        $('#edit_admin_id').val(adminId);
        $('#edit_first_name').val(firstName);
        $('#edit_last_name').val(lastName);
        $('#edit_email').val(email);
        $('#edit_phone_number').val(phoneNumber);
        $('#edit_country_code').val(countryCode).trigger('change.select2');
        $('#edit_status').val(isActive ? "true" : "false").trigger('change.select2');
        
        $('#editAdminForm').attr('action', `{% url 'admin_panel:admin_edit' 0 %}`.replace('0', adminId));
    });

    // Delete admin modal
    $('.delete-admin').click(function() {
        var adminId = $(this).data('admin-id');
        $('#deleteAdminForm').attr('action', `{% url 'admin_panel:admin_delete' 0 %}`.replace('0', adminId));
    });

    // Reset password modal
    $('.reset-password').click(function() {
        var adminId = $(this).data('admin-id');
        $('#resetAdminPasswordForm').attr('action', `{% url 'admin_panel:admin_toggle' 0 %}`.replace('0', adminId));
    });

    // Update admin counts
    function updateAdminCounts() {
        let activeCount = 0;
        let inactiveCount = 0;
        
        $('.toggle-status').each(function() {
            if ($(this).is(':checked')) {
                activeCount++;
            } else {
                inactiveCount++;
            }
        });

        $('#activeCount').text(activeCount);
        $('#inactiveCount').text(inactiveCount);
    }
    
    updateAdminCounts();
    
    $('.toggle-status').change(function() {
        updateAdminCounts();
    });
});
</script>
{% endblock %}