{% extends 'custom-admin/base.html' %}
{% load static %}
{% block content %}

<section class="manageActivitiesPage managepadding manageallpage">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="topContent">
          <h2 class="H2Heading">Manage News</h2>
          <button class="topContentButton" data-bs-toggle="modal" data-bs-target="#addNewsModal">
            <i class="fa fa-plus" aria-hidden="true"></i>
            Add News
          </button>
        </div>

        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{% if message.tags == "error" %}danger alert-dismissible fade show{% else %}{{message.tags}} alert-dismissible fade show{% endif %}" role="alert">
              {{ message }}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          {% endfor %}
        {% endif %}

        <div class="scrollableTable">
          <div class="tableInputFilter">
            <form method="GET" class="mb-4">
              <div class="input-group">
                <input type="search" class="customInput searchTable" name="search" 
                       placeholder="Search by title or content" value="{{ search_query }}">
              </div>
            </form>
          </div>

          <table cellpadding="1" cellspacing="1">
            <thead>
              <tr>
                <th>Article ID</th>
                <th>Icon</th>
                <th>Title</th>
                <th>Content Preview</th>
                <th>Published Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for article in news %}
              <tr>
                <td>#{{ article.id }}</td>
                <td>
                  {% if article.icon %}
                    <img src="{{ article.icon.url }}" alt="{{ article.title }}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                  {% else %}
                    <span class="badge bg-secondary">No Icon</span>
                  {% endif %}
                </td>
                <td>
                  <strong>{{ article.title|truncatewords:5 }}</strong>
                </td>
                <td>
                  <small>{{ article.content|truncatewords:15 }}</small>
                </td>
                <td>{{ article.published_at|date:"d/m/Y H:i" }}</td>
                <td>
                  <button class="tableActionBtn edit-news" 
                          data-bs-toggle="modal"
                          data-bs-target="#editNewsModal"
                          data-news-id="{{ article.id }}"
                          data-title="{{ article.title|escapejs }}"
                          data-content="{{ article.content|escapejs }}"
                          data-icon-url="{% if article.icon %}{{ article.icon.url }}{% endif %}"
                          data-published="{{ article.published_at|date:'d/m/Y H:i' }}"
                          data-edit-url="{% url 'admin_panel:news_edit' article.id %}">
                    <i class="fa fa-edit"></i>
                  </button>
                  <button class="tableActionBtn delete-news" 
                          data-bs-toggle="modal"
                          data-bs-target="#deleteNewsModal"
                          data-news-id="{{ article.id }}"
                          data-delete-url="{% url 'admin_panel:news_delete' article.id %}">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center">No news articles found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- PAGINATION -->
          {% if news.has_other_pages %}
          <div class="tablePagination">
            <nav aria-label="Page navigation">
              <ul class="pagination">
                {% if news.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ news.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                {% endif %}

                {% for num in news.paginator.page_range %}
                  <li class="page-item {% if news.number == num %}active{% endif %}">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                  </li>
                {% endfor %}

                {% if news.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ news.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ADD NEWS MODAL -->
<div class="modal fade customModal addDataModal" id="addNewsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="H2Heading">Add New Article</h6>
        <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
          <img src="{% static 'admin/images/close.png' %}" alt="" class="img-fluid">
        </button>
      </div>
      <div class="modal-body">
        <form method="post" action="{% url 'admin_panel:news_add' %}" enctype="multipart/form-data" id="addNewsForm">
          {% csrf_token %}
          <div class="row row-gap-4">
            <div class="col-md-12">
              <label class="inputLabel">Article Title <span style="color: red;">*</span></label>
              <input type="text" name="title" class="customInput" placeholder="Enter article title" required>
            </div>

            <div class="col-md-12">
              <label class="inputLabel">Article Content <span style="color: red;">*</span></label>
              <textarea name="content" class="customInput" rows="6" placeholder="Enter detailed article content" required></textarea>
            </div>

            <div class="col-md-12">
              <label class="inputLabel">Article Icon/Image</label>
              <div class="upload-area" id="uploadArea">
                <input type="file" name="icon" id="iconInput" accept="image/*" style="display: none;">
                <div style="text-align: center; padding: 20px; border: 2px dashed #ccc; border-radius: 8px; cursor: pointer;">
                  <i class="fa fa-cloud-upload" style="font-size: 2rem; color: #667eea;"></i>
                  <p class="mt-2">Drag and drop image here or click to select</p>
                  <small class="text-muted">PNG, JPG, GIF (Max 5MB)</small>
                </div>
                <div id="imagePreview" style="margin-top: 10px;">
                  <!-- Image preview will appear here -->
                </div>
              </div>
            </div>

            <div class="modalFooter">
              <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="customButton ms-2">Add Article</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- EDIT NEWS MODAL -->
<div class="modal fade customModal addDataModal" id="editNewsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="H2Heading">Edit Article</h6>
        <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
          <img src="{% static 'admin/images/close.png' %}" alt="" class="img-fluid">
        </button>
      </div>
      <div class="modal-body">
        <form method="post" id="editNewsForm" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="news_id" id="edit_news_id">
          <div class="row row-gap-4">
            <div class="col-md-12">
              <label class="inputLabel">Article Title</label>
              <input type="text" name="title" id="edit_title" class="customInput" placeholder="Enter article title">
            </div>

            <div class="col-md-12">
              <label class="inputLabel">Article Content</label>
              <textarea name="content" id="edit_content" class="customInput" rows="6" placeholder="Enter detailed article content"></textarea>
            </div>

            <div class="col-md-12">
              <label class="inputLabel">Article Icon/Image</label>
              <div class="upload-area" id="editUploadArea">
                <input type="file" name="icon" id="editIconInput" accept="image/*" style="display: none;">
                <div style="text-align: center; padding: 20px; border: 2px dashed #ccc; border-radius: 8px; cursor: pointer;">
                  <i class="fa fa-cloud-upload" style="font-size: 2rem; color: #667eea;"></i>
                  <p class="mt-2">Drag and drop image here or click to select</p>
                  <small class="text-muted">PNG, JPG, GIF (Max 5MB)</small>
                </div>
                <div id="editImagePreview" style="margin-top: 10px;">
                  <!-- Image preview will appear here -->
                </div>
              </div>
            </div>

            <div class="col-md-12">
              <small class="text-muted">Published: <span id="edit_published_date"></span></small>
            </div>

            <div class="modalFooter">
              <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="customButton ms-2">Update Article</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- DELETE NEWS MODAL -->
<div class="modal fade customModal addDataModal" id="deleteNewsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content text-center" style="height: 340px;">
      <div class="modal-body">
        <img src="{% static 'admin/images/svg-icon/Delete.svg' %}" alt="">
        <form method="post" id="deleteNewsForm">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-12 my-4">
              <h2 class="H2Heading">Confirm Delete</h2>
              <h5 class="H5Heading mt-3">Are you sure you want to delete this article? This action cannot be undone.</h5>
            </div>

            <div class="modalFooter">
              <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="customRedButton ms-3">Delete</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extrajs %}
<script>
$(document).ready(function() {
    let searchTimeout;
    
    // Debounce search
    $('.searchTable').on('keyup', function() {
        clearTimeout(searchTimeout);
        const searchValue = $(this).val();
        
        searchTimeout = setTimeout(function() {
            if (searchValue.length > 0 || searchValue.length === 0) {
                $('form').first().submit();
            }
        }, 500);
    });

    // ===== IMAGE UPLOAD HANDLERS =====

    // Add News modal - image upload
    const addUploadArea = document.getElementById('uploadArea');
    const addIconInput = document.getElementById('iconInput');
    const addImagePreview = document.getElementById('imagePreview');

    if (addUploadArea && addIconInput) {
        addUploadArea.querySelector('div').addEventListener('click', function() {
            addIconInput.click();
        });

        addUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.opacity = '0.5';
        });

        addUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.opacity = '1';
        });

        addUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.opacity = '1';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                addIconInput.files = files;
                handleImagePreview(addIconInput, addImagePreview);
            }
        });

        addIconInput.addEventListener('change', function() {
            handleImagePreview(this, addImagePreview);
        });
    }

    // Edit News modal - image upload
    const editUploadArea = document.getElementById('editUploadArea');
    const editIconInput = document.getElementById('editIconInput');
    const editImagePreview = document.getElementById('editImagePreview');

    if (editUploadArea && editIconInput) {
        editUploadArea.querySelector('div').addEventListener('click', function() {
            editIconInput.click();
        });

        editUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.opacity = '0.5';
        });

        editUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.opacity = '1';
        });

        editUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.opacity = '1';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                editIconInput.files = files;
                handleImagePreview(editIconInput, editImagePreview);
            }
        });

        editIconInput.addEventListener('change', function() {
            handleImagePreview(this, editImagePreview);
        });
    }

    // Handle image preview
    function handleImagePreview(inputElement, previewContainer) {
        const file = inputElement.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <div style="position: relative; display: inline-block;">
                        <img src="${e.target.result}" alt="Preview" style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px;">
                        <button type="button" class="btn btn-sm btn-danger" style="position: absolute; top: 5px; right: 5px;" onclick="clearImage(this)">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }
    }

    window.clearImage = function(btn) {
        const previewContainer = btn.closest('#imagePreview') || btn.closest('#editImagePreview');
        previewContainer.innerHTML = '';
        const input = previewContainer.parentElement.querySelector('input[type="file"]');
        if (input) {
            input.value = '';
        }
    };

    // ===== EDIT NEWS MODAL =====

    $('.edit-news').click(function() {
        var newsId = $(this).data('news-id');
        var title = $(this).data('title');
        var content = $(this).data('content');
        var iconUrl = $(this).data('icon-url');
        var published = $(this).data('published');
        var editUrl = $(this).data('edit-url');

        $('#edit_news_id').val(newsId);
        $('#edit_title').val(title);
        $('#edit_content').val(content);
        $('#edit_published_date').text(published);

        // Show current image
        if (iconUrl) {
            const previewHTML = `
                <div style="text-align: center;">
                    <p class="text-muted mb-2">Current Image:</p>
                    <img src="${iconUrl}" alt="Current" style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px;">
                </div>
            `;
            document.getElementById('editImagePreview').innerHTML = previewHTML;
        } else {
            document.getElementById('editImagePreview').innerHTML = '';
        }

        $('#editNewsForm').attr('action', editUrl);
    });

    // ===== DELETE NEWS MODAL =====
    $('.delete-news').click(function() {
        var deleteUrl = $(this).data('delete-url');
        $('#deleteNewsForm').attr('action', deleteUrl);
    });

    // Form validation for add news
    $('#addNewsForm').submit(function(e) {
        const title = $('input[name="title"]').val();
        const content = $('textarea[name="content"]').val();
        
        if (title.length < 5) {
            e.preventDefault();
            alert('Title must be at least 5 characters');
            return false;
        }
        
        if (content.length < 20) {
            e.preventDefault();
            alert('Content must be at least 20 characters');
            return false;
        }
    });

    // Form validation for edit news
    $('#editNewsForm').submit(function(e) {
        const title = $('#edit_title').val();
        const content = $('#edit_content').val();
        
        if (title.length < 5) {
            e.preventDefault();
            alert('Title must be at least 5 characters');
            return false;
        }
        
        if (content.length < 20) {
            e.preventDefault();
            alert('Content must be at least 20 characters');
            return false;
        }
    });
});
</script>
{% endblock %}