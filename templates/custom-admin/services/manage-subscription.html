{% extends 'custom-admin/base.html' %}
{% load static %}

{% block content %}
<section class="manageActivitiesPage managepadding manageallpage">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <!-- Top Content -->
                <div class="topContent">
                    <h2 class="H2Heading">Manage Subscriptions</h2>
                </div>

                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{% if message.tags == "error" %}danger{% else %}{{message.tags}}{% endif %} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}

                <!-- Table Section -->
                <div class="scrollableTable">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="tableInputFilter ms-0">
                                <div class="activeInactiveUser">
                                    <button class="customButton" id="activeSubBtn">Active <span id="activeCount">0</span></button>
                                    <button class="customButton ms-2" id="inactiveSubBtn">Inactive <span id="inactiveCount">0</span></button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <form method="GET" class="mb-4">
                                <div class="input-group">
                                    <input type="search" class="customInput searchTable" name="search" 
                                           placeholder="Search by user or plan" 
                                           value="{{ search_query }}">
                                </div>
                            </form>
                        </div>
                    </div>

                    <div>
                        <table cellpadding="1" cellspacing="1">
                            <tr >
                                <th>ID</th>
                                <th>User</th>
                                <th>Plan</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            <tbody>
                                {% if subscriptions %}
                                {% for subscription in subscriptions %}
                                <tr>
                                    <td>{{ subscription.id }}</td>
                                    <td>{{ subscription.user.email }}</td>
                                    <td>{{ subscription.plan.name }}</td>
                                    <td>{{ subscription.start_date|date }}</td>
                                    <td>{{ subscription.end_date|date }}</td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <form method="post" action="">
                                                {% csrf_token %}
                                                <input class="form-check-input toggle-status" 
                                                       type="checkbox" 
                                                       {% if subscription.status %}checked{% endif %}
                                                       onchange="this.form.submit()">
                                            </form>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="tableActionBtn edit-subscription" 
                                                data-subscription-id="{{ subscription.id }}"
                                                data-user="{{ subscription.user.email }}"
                                                data-plan="{{ subscription.plan.id }}"
                                                data-start-date="{{ subscription.start_date|date:'Y-m-d' }}"
                                                data-end-date="{{ subscription.end_date|date:'Y-m-d' }}"
                                                data-status="{{ subscription.status|lower }}">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button class="tableActionBtn delete-subscription" 
                                                data-subscription-id="{{ subscription.id }}">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">No subscriptions found.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>

                        <!-- Pagination -->
                        <div class="tablePagination">
                            <nav aria-label="Page navigation">
                                <ul class="pagination">
                                    {% if subscriptions.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ subscriptions.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                    {% endif %}

                                    {% for num in subscriptions.paginator.page_range %}
                                        <li class="page-item {% if subscriptions.number == num %}active{% endif %}">
                                            <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                                        </li>
                                    {% endfor %}

                                    {% if subscriptions.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ subscriptions.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Delete Subscription Modal -->
<div class="modal fade customModal addDataModal" id="deleteSubscriptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content text-center" style="height: 340px;">
            <div class="modal-body">
                <img src="{% static 'admin/images/svg-icon/Delete.svg' %}" alt="">
                <form method="post" id="deleteSubscriptionForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-12 my-4">
                            <h2 class="H2Heading">Confirm Delete</h2>
                            <h5 class="H5Heading mt-3">Are you sure you want to delete this subscription?</h5>
                        </div>
                        <div class="modalFooter">
                            <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="customRedButton ms-3">Delete</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Subscription Modal -->
<div class="modal fade customModal addDataModal" id="editSubscriptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="H2Heading">Edit Subscription</h6>
                <button type="button" class="hideClose_Modal" data-bs-dismiss="modal">
                    <img src="{% static 'admin/images/close.png' %}" alt="" class="img-fluid">
                </button>
            </div>
            <div class="modal-body">
                <form method="post" id="editSubscriptionForm">
                    {% csrf_token %}
                    <div class="row row-gap-4">
                        <div class="col-md-12">
                            <label class="inputLabel">User Email</label>
                            <input type="text" id="edit_user_email" class="customInput" disabled>
                        </div>

                        <div class="col-md-12">
                            <label class="inputLabel">Plan</label>
                            <div class="customSingleSelect">
                                <div class="select-icon">
                                    <i class="fa fa-angle-down selectIcon"></i>
                                    <select name="plan" id="edit_plan" class="icons_select2" required>
                                        {% for plan in plans %}
                                            <option value="{{ plan.id }}">{{ plan.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">Start Date</label>
                            <input type="date" name="start_date" id="edit_start_date" class="customInput" required>
                        </div>

                        <div class="col-md-6">
                            <label class="inputLabel">End Date</label>
                            <input type="date" name="end_date" id="edit_end_date" class="customInput" required>
                        </div>

                        <div class="col-md-12">
                            <label class="inputLabel">Status</label>
                            <div class="customSingleSelect">
                                <div class="select-icon">
                                    <i class="fa fa-angle-down selectIcon"></i>
                                    <select name="status" id="edit_status" class="icons_select2">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="modalFooter">
                            <button type="button" class="customButton" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="customButton ms-2">Update</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script>
$(document).ready(function() {
    // Delete subscription modal
    $('.delete-subscription').click(function() {
        var subscriptionId = $(this).data('subscription-id');
        $('#deleteSubscriptionForm').attr('action', `/subscriptions/${subscriptionId}/delete/`);
        $('#deleteSubscriptionModal').modal('show');
    });

    // Update subscription counts
    function updateSubscriptionCounts() {
        let activeCount = 0;
        let inactiveCount = 0;
        
        $('.toggle-status').each(function() {
            if ($(this).is(':checked')) {
                activeCount++;
            } else {
                inactiveCount++;
            }
        });

        $('#activeCount').text(activeCount);
        $('#inactiveCount').text(inactiveCount);
    }

    updateSubscriptionCounts();
    
    $('.toggle-status').change(function() {
        updateSubscriptionCounts();
    });

    // Edit subscription modal
    $('.edit-subscription').click(function() {
        var subscriptionId = $(this).data('subscription-id');
        var userEmail = $(this).data('user');
        var planId = $(this).data('plan');
        var startDate = $(this).data('start-date');
        var endDate = $(this).data('end-date');
        var status = $(this).data('status');

        $('#editSubscriptionForm').attr('action', `/user-subscriptions/${subscriptionId}/edit/`);
        $('#edit_user_email').val(userEmail);
        $('#edit_plan').val(planId).trigger('change');
        $('#edit_start_date').val(startDate);
        $('#edit_end_date').val(endDate);
        $('#edit_status').val(status ? "true" : "false").trigger('change.select2');

        $('#editSubscriptionModal').modal('show');
    });
});
</script>
{% endblock %}